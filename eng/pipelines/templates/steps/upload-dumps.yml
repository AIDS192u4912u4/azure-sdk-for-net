steps:
  - pwsh: |
      New-Item $(Build.ArtifactStagingDirectory)/dumps -ItemType directory
      foreach($dumpFile in (Get-ChildItem -Path . -Recurse -Filter *.dmp -File))
      {
        $fileFullName = $dumpFile.FullName
        $fileName = $dumpFile.Name
        Move-Item -Path $fileFullName -Destination $(Build.ArtifactStagingDirectory)/dumps/$fileName -ErrorAction SilentlyContinue
        Write-Host "##vso[task.setvariable variable=uploadDump]true"
      }
      [System.IO.Compression.ZipFile]::CreateFromDirectory("$(Build.ArtifactStagingDirectory)/dumps","$(Build.ArtifactStagingDirectory)/dumps.zip")
    condition: always()
    displayName: Copy dumps to staging directory
  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      CustomCondition: eq(variables['uploadDump'], 'true')
      ArtifactName: "Crash Dump - $(System.JobName) - $(System.JobAttempt)"
      ArtifactPath: '$(Build.ArtifactStagingDirectory)/dumps.zip'
      SbomEnabled: false
